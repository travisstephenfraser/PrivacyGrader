{% extends "base.html" %}
{% block title %}Exams — Rubrica{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">Uploaded Exams</h2>
  <a href="/upload-batch" class="btn btn-outline-primary btn-sm">+ Upload more</a>
</div>

<!-- Filter + action bar -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex align-items-end flex-wrap gap-2">

      <!-- Filter label -->
      <span class="fw-semibold me-1 align-self-center">Filter</span>

      {% if missing_rubric_versions %}
      <div class="alert alert-warning py-1 px-2 mb-0 small align-self-center">
        <strong>⚠ Missing rubric for Version{{ 's' if missing_rubric_versions|length > 1 else '' }}:
        {{ missing_rubric_versions | join(', ') }}</strong> —
        <a href="/setup" class="alert-link">Set up →</a>
      </div>
      {% endif %}

      <form method="POST" action="/grade-all" class="d-flex gap-2 align-items-end flex-wrap mb-0">
        <select name="version" class="form-select form-select-sm" style="width:120px">
          <option value="">All versions</option>
          <option value="A">Version A</option>
          <option value="B">Version B</option>
        </select>
        <select name="batch" class="form-select form-select-sm" style="width:120px">
          <option value="">All batches</option>
          <option value="1">Batch 1</option>
          <option value="2">Batch 2</option>
          <option value="3">Batch 3</option>
          <option value="4">Batch 4</option>
          <option value="5">Batch 5</option>
        </select>
        <button type="submit" class="btn btn-success btn-sm"
                title="Grade all ungraded exams matching the selected filters. Calls the Claude API."
                onclick="return confirm('Grade all ungraded exams matching the selected filters? This will call the Claude API.')">
          ▶ Grade All
        </button>
      </form>

      <!-- Danger actions pushed to the right -->
      <div class="ms-auto d-flex gap-2">
        <form method="POST" action="/clear-all-grades">
          <button type="submit" class="btn btn-outline-warning btn-sm"
                  title="Clears saved grades so all exams can be re-graded. Does not delete exam PDFs or rubrics."
                  onclick="return confirm('Clear ALL saved grades? This cannot be undone. Exams and rubrics are kept.')">
            Clear All Grades
          </button>
        </form>
        <form method="POST" action="/exams/delete-all">
          <button type="submit" class="btn btn-outline-danger btn-sm"
                  title="Permanently deletes every exam record and its PDF from disk. Rubrics and roster are kept."
                  onclick="return confirm('Remove ALL exams? This permanently deletes every exam PDF and cannot be undone.')">
            Remove All Exams
          </button>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- Grade Selected toolbar (appears when checkboxes are checked) -->
<div id="grade-selected-bar" class="d-none mb-3 d-flex align-items-center gap-3 px-3 py-2 bg-white rounded shadow-sm border">
  <span id="selected-count" class="fw-semibold text-muted small">0 selected</span>
  <button id="grade-selected-btn" class="btn btn-success btn-sm" disabled>
    ▶ Grade Selected
  </button>
  <button type="button" id="deselect-all-btn" class="btn btn-outline-secondary btn-sm ms-auto">
    Clear selection
  </button>
</div>

{% if exams %}
<table class="table table-hover align-middle">
  <thead class="table-light">
    <tr>
      <th style="width:36px">
        <input type="checkbox" id="select-all-cb" class="form-check-input" title="Select all">
      </th>
      <th>Anon ID</th>
      <th>Version</th>
      <th>Batch</th>
      <th>Uploaded</th>
      <th>Graded</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for e in exams %}
    <tr>
      <td>
        <input type="checkbox" class="exam-checkbox form-check-input" value="{{ e.anon_id }}">
      </td>
      <td><span class="anon-id">{{ e.anon_id }}</span></td>
      <td>
        <span class="badge bg-secondary">Version {{ e.version }}</span>
        {% if e.version in rubric_versions %}
          <span class="badge bg-success ms-1" title="Rubric found for Version {{ e.version }}">✓ Rubric</span>
        {% else %}
          <span class="badge bg-danger ms-1" title="No rubric found for Version {{ e.version }} — grading will fail">✗ No Rubric</span>
        {% endif %}
      </td>
      <td>Batch {{ e.batch }}</td>
      <td class="text-muted small">{{ e.uploaded_at }}</td>

      <!-- Grade status -->
      <td>
        {% if e.graded %}
          <button type="button" class="btn btn-sm btn-success grade-one-btn"
                  data-anon-id="{{ e.anon_id }}" data-regrade="1">
            ✓ Re-grade
          </button>
        {% else %}
          <button type="button" class="btn btn-sm btn-outline-success grade-one-btn"
                  data-anon-id="{{ e.anon_id }}">
            Grade
          </button>
        {% endif %}
      </td>

      <td class="d-flex gap-1 flex-wrap">
        <a href="/exam/{{ e.anon_id }}" class="btn btn-sm btn-outline-primary">Review</a>
        {% if e.graded %}
          <a href="/results" class="btn btn-sm btn-outline-secondary">Results</a>
          <form method="POST" action="/exam/{{ e.anon_id }}/clear-grade"
                onsubmit="return confirm('Clear grade for {{ e.anon_id }}? This cannot be undone.')">
            <button type="submit" class="btn btn-sm btn-outline-warning">Clear</button>
          </form>
        {% endif %}
        <form method="POST" action="/exam/{{ e.anon_id }}/delete"
              onsubmit="return confirm('Remove exam {{ e.anon_id }}? This cannot be undone.')">
          <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="text-center text-muted py-5">
  <p class="fs-5">No exams uploaded yet.</p>
  <a href="/upload-batch" class="btn btn-primary">Upload Exams</a>
</div>
{% endif %}

<div class="d-flex justify-content-between mt-4">
  <a href="/upload-batch" class="btn btn-secondary">← Back</a>
  <a href="/results" class="btn btn-primary">Next: View Results →</a>
</div>

<script>
(function () {
  var selectAllCb  = document.getElementById('select-all-cb');
  var selBar       = document.getElementById('grade-selected-bar');
  var selCount     = document.getElementById('selected-count');
  var gradeSelBtn  = document.getElementById('grade-selected-btn');
  var deselectBtn  = document.getElementById('deselect-all-btn');

  function getChecked() {
    return Array.from(document.querySelectorAll('.exam-checkbox:checked'));
  }

  function updateSelUI() {
    var n = getChecked().length;
    selCount.textContent = n + ' selected';
    gradeSelBtn.disabled = (n === 0);
    if (n > 0) selBar.classList.remove('d-none');
    else selBar.classList.add('d-none');
  }

  if (selectAllCb) {
    selectAllCb.addEventListener('change', function () {
      document.querySelectorAll('.exam-checkbox').forEach(function (cb) {
        cb.checked = selectAllCb.checked;
      });
      updateSelUI();
    });
  }

  document.querySelectorAll('.exam-checkbox').forEach(function (cb) {
    cb.addEventListener('change', updateSelUI);
  });

  deselectBtn.addEventListener('click', function () {
    document.querySelectorAll('.exam-checkbox').forEach(function (cb) { cb.checked = false; });
    if (selectAllCb) selectAllCb.checked = false;
    updateSelUI();
  });

  // ---- Core: submit a list of anon_ids to /grade-selected ----
  function submitGradeJob(anonIds, doneCb) {
    var fd = new FormData();
    anonIds.forEach(function (id) { fd.append('anon_ids', id); });
    fetch('/grade-selected', { method: 'POST', body: fd })
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (data.error) {
          alert(data.error);
          if (doneCb) doneCb(false);
        } else {
          if (typeof window.startGradePolling === 'function') window.startGradePolling();
          if (doneCb) doneCb(true);
        }
      })
      .catch(function () {
        alert('Failed to start grading. Please try again.');
        if (doneCb) doneCb(false);
      });
  }

  // Grade Selected button
  gradeSelBtn.addEventListener('click', function () {
    var ids = getChecked().map(function (cb) { return cb.value; });
    if (ids.length === 0) return;
    if (!confirm('Grade ' + ids.length + ' selected exam(s)? This will call the Claude API.')) return;
    gradeSelBtn.disabled = true;
    gradeSelBtn.textContent = 'Starting…';
    submitGradeJob(ids, function (ok) {
      gradeSelBtn.textContent = '▶ Grade Selected';
      if (ok) {
        document.querySelectorAll('.exam-checkbox').forEach(function (cb) { cb.checked = false; });
        if (selectAllCb) selectAllCb.checked = false;
        updateSelUI();
      } else {
        gradeSelBtn.disabled = false;
      }
    });
  });

  // Individual Grade / Re-grade buttons
  document.querySelectorAll('.grade-one-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var anonId   = btn.dataset.anonId;
      var isRegrade = btn.dataset.regrade === '1';
      var msg = isRegrade
        ? 'Re-grade ' + anonId + '? This will overwrite the existing grade.'
        : 'Grade ' + anonId + '? This will call the Claude API.';
      if (!confirm(msg)) return;
      var orig = btn.textContent;
      btn.disabled = true;
      btn.textContent = '…';
      submitGradeJob([anonId], function (ok) {
        if (!ok) {
          btn.disabled = false;
          btn.textContent = orig;
        }
        // on success: leave button disabled — banner shows progress
      });
    });
  });
}());
</script>
{% endblock %}
