{% extends "base.html" %}
{% block title %}Name Assignment — Upload{% endblock %}
{% block extra_head %}
<style>
  .names-hidden .name-cell,
  .names-hidden .sid-cell { opacity: 0; }
  .cover-blurred { filter: blur(10px); transition: filter 0.2s; }
</style>
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-0">Assign Student Names</h2>
    <p class="text-muted mb-0 mt-1">
      Version <strong>{{ version }}</strong> ·
      <strong>{{ exams|length }}</strong> exam{{ 's' if exams|length != 1 else '' }} split from PDF
    </p>
  </div>
  <a href="/upload-batch" class="btn btn-outline-secondary btn-sm">← Start over</a>
</div>

{% if ocr_running %}
<div id="ocr-banner" class="alert alert-info d-flex align-items-center gap-3 mb-3">
  <div class="spinner-border spinner-border-sm flex-shrink-0" role="status" id="ocr-spinner"></div>
  <div class="flex-grow-1">
    <div class="d-flex justify-content-between mb-1">
      <span id="ocr-label" class="small fw-semibold">Extracting names from cover pages…</span>
      <span id="ocr-counts" class="small text-muted"></span>
    </div>
    <div class="progress" style="height:6px">
      <div id="ocr-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info"
           role="progressbar" style="width:0%"></div>
    </div>
  </div>
  <button id="ocr-abort-btn" type="button" class="btn btn-sm btn-outline-danger flex-shrink-0"
          onclick="abortOcr()">Stop</button>
</div>
{% endif %}

<div class="alert alert-info py-2 mb-3 small">
  <strong>Tip:</strong> Ollama auto-extracts names &amp; SIDs from each cover page — verify and correct as needed.
  Click a thumbnail or <em>Review</em> to confirm all pages are attached.
  Names and SIDs are stored locally only and <strong>never</strong> sent to Claude for grading.
</div>

{% if roster_count and roster_count > 0 %}
<div class="card border-0 shadow-sm mb-3 border-start border-4 border-success">
  <div class="card-body py-2 px-3 d-flex align-items-center gap-3 flex-wrap">
    <div>
      <span class="badge bg-success">{{ roster_count }} students in roster</span>
      <span class="text-muted small ms-2">Fuzzy-match OCR names/SIDs against your class roster — runs locally, no API call.</span>
    </div>
    <button type="button" class="btn btn-success btn-sm" id="matchRosterBtn" onclick="matchRoster()">
      Match against Roster
    </button>
    <span id="matchSummary" class="text-muted small"></span>
  </div>
</div>
{% endif %}

<form method="POST" action="/upload-batch/confirm/{{ review_id }}" id="confirmForm">
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body p-0">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:40px">#</th>
            <th style="width:90px">Cover</th>
            <th>Student Name</th>
            <th style="width:160px">SID</th>
            <th style="width:80px" class="text-muted small">Batch</th>
            <th style="width:100px" class="text-muted small">Roster Match</th>
            <th style="width:110px" class="text-muted small">Pages in PDF</th>
            <th style="width:90px"></th>
          </tr>
        </thead>
        <tbody id="examTbody"{% if private_mode %} class="names-hidden"{% endif %}>
          {% for exam in exams %}
          <tr>
            <td class="text-muted">{{ loop.index }}</td>

            <!-- Thumbnail of cover page (page 0) -->
            <td>
              <img src="/upload-batch/preview/{{ review_id }}/{{ loop.index0 }}/0?thumb=1"
                   loading="lazy"
                   style="height:70px; width:auto; cursor:pointer; border-radius:4px; border:1px solid {% if exam.cover_flag %}#ffc107{% else %}#dee2e6{% endif %};"
                   onclick="openReview({{ loop.index0 }}, {{ exam.page_count }}, {{ loop.index }})"
                   title="Click to review all pages"
                   alt="Cover page">
              {% if exam.cover_flag %}
              <div><span class="badge bg-warning text-dark mt-1" style="font-size:.65rem;"
                         title="Cover page differs from the majority — verify this exam">⚠ Cover</span></div>
              {% endif %}
            </td>

            <!-- Name input (pre-filled by Claude) -->
            <td class="name-cell">
              <input type="text" name="name_{{ loop.index0 }}"
                     class="form-control form-control-sm"
                     value="{{ exam.name }}"
                     placeholder="Leave blank to enter later">
            </td>

            <!-- SID input (pre-filled by Claude) -->
            <td class="sid-cell">
              <input type="text" name="sid_{{ loop.index0 }}"
                     class="form-control form-control-sm font-monospace"
                     value="{{ exam.sid }}"
                     placeholder="SID">
            </td>

            <!-- Batch number -->
            <td class="text-muted small">Batch {{ exam.batch }}</td>

            <!-- Roster match confidence badge -->
            <td><span id="conf-{{ loop.index0 }}" class="badge bg-secondary" style="font-size:.75rem;"></span></td>

            <!-- Page range -->
            <td class="text-muted font-monospace small">{{ exam.pages }}</td>

            <!-- Review button -->
            <td>
              <button type="button" class="btn btn-sm btn-outline-secondary"
                      onclick="openReview({{ loop.index0 }}, {{ exam.page_count }}, {{ loop.index }})">
                Review
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</form>

<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
  <div class="d-flex gap-2">
    <button type="submit" form="confirmForm" class="btn btn-success px-4">
      ✓ Save {{ exams|length }} Exam{{ 's' if exams|length != 1 else '' }}
    </button>
    <form method="POST" action="/upload-batch/discard/{{ review_id }}"
          onsubmit="return confirm('Discard this session? Split PDFs will be deleted.')">
      <button type="submit" class="btn btn-outline-danger">✗ Discard &amp; Start Over</button>
    </form>
  </div>
  <a href="/exams" class="btn btn-primary">Next: View Exams →</a>
</div>

<!-- ── Page review modal ─────────────────────────────────────── -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header py-2">
        <h5 class="modal-title" id="reviewModalLabel">Exam Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <!-- Page navigation buttons -->
        <div id="pageNavBtns" class="d-flex flex-wrap gap-1 mb-3"></div>

        <!-- Page image -->
        <div class="text-center">
          <img id="modalImg" src="" class="img-fluid border rounded shadow-sm{% if private_mode %} cover-blurred{% endif %}"
               style="max-height:78vh" alt="Exam page">
          <p id="modalPageLabel" class="text-muted small mt-2 mb-0"></p>
        </div>
      </div>

      <div class="modal-footer py-2">
        <button type="button" class="btn btn-outline-secondary btn-sm"
                id="prevPageBtn" onclick="stepPage(-1)">← Prev</button>
        <button type="button" class="btn btn-outline-secondary btn-sm"
                id="nextPageBtn" onclick="stepPage(1)">Next →</button>
        <button type="button" class="btn btn-secondary btn-sm ms-3"
                data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<script>
const reviewId    = "{{ review_id }}";
const privateMode = {{ 'true' if private_mode else 'false' }};
let activeExam  = 0;
let activePage  = 0;
let totalPages  = 0;
let modalInst   = null;

function openReview(examIndex, pageCount, examNum) {
  activeExam = examIndex;
  totalPages = pageCount;
  activePage = 0;

  document.getElementById('reviewModalLabel').textContent =
    `Exam #${examNum} — ${pageCount} page${pageCount !== 1 ? 's' : ''}`;

  buildPageNav();
  loadPage(0);

  if (!modalInst) {
    modalInst = new bootstrap.Modal(document.getElementById('reviewModal'));
  }
  modalInst.show();
}

function buildPageNav() {
  const nav = document.getElementById('pageNavBtns');
  nav.innerHTML = '';
  for (let i = 0; i < totalPages; i++) {
    const btn = document.createElement('button');
    btn.type      = 'button';
    btn.className = 'btn btn-sm ' + (i === 0 ? 'btn-secondary' : 'btn-outline-secondary');
    btn.textContent = i === 0 ? 'Cover' : `Page ${i + 1}`;
    btn.dataset.page = i;
    btn.onclick   = () => loadPage(i);
    nav.appendChild(btn);
  }
}

function loadPage(pageNum) {
  activePage = pageNum;
  const img = document.getElementById('modalImg');
  img.classList.toggle('cover-blurred', pageNum === 0 && privateMode);
  img.src = `/upload-batch/preview/${reviewId}/${activeExam}/${pageNum}`;
  document.getElementById('modalPageLabel').textContent =
    pageNum === 0
      ? `Cover page (page 1 of ${totalPages})`
      : `Page ${pageNum + 1} of ${totalPages}`;

  document.querySelectorAll('#pageNavBtns button').forEach((btn, i) => {
    btn.className = 'btn btn-sm ' + (i === pageNum ? 'btn-secondary' : 'btn-outline-secondary');
  });

  document.getElementById('prevPageBtn').disabled = pageNum === 0;
  document.getElementById('nextPageBtn').disabled = pageNum === totalPages - 1;
}

function stepPage(delta) {
  const next = activePage + delta;
  if (next >= 0 && next < totalPages) loadPage(next);
}

// ── Background OCR polling ───────────────────────────────────────────────────
{% if ocr_running %}
// Track user edits so polling never overwrites manual input
document.querySelectorAll('[name^="name_"],[name^="sid_"]').forEach(function(el) {
  el.addEventListener('input', function() { el.dataset.userEdited = '1'; });
});

(function pollOcr() {
  fetch('/upload-batch/ocr-status/{{ review_id }}')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var banner = document.getElementById('ocr-banner');
      if (!banner) return;

      var pct = data.total > 0 ? Math.round(data.done / data.total * 100) : 0;
      document.getElementById('ocr-bar').style.width = pct + '%';
      document.getElementById('ocr-counts').textContent = data.done + ' / ' + data.total;

      if (data.exams) {
        data.exams.forEach(function(exam, i) {
          var nameEl = document.querySelector('[name="name_' + i + '"]');
          var sidEl  = document.querySelector('[name="sid_'  + i + '"]');
          if (nameEl && !nameEl.dataset.userEdited && exam.name) nameEl.value = exam.name;
          if (sidEl  && !sidEl.dataset.userEdited  && exam.sid)  sidEl.value  = exam.sid;
        });
      }

      if (data.running) {
        setTimeout(pollOcr, 2000);
      } else {
        var spinner = document.getElementById('ocr-spinner');
        var abortBtn = document.getElementById('ocr-abort-btn');
        if (spinner) spinner.classList.add('d-none');
        if (abortBtn) abortBtn.classList.add('d-none');
        document.getElementById('ocr-bar').classList.remove('progress-bar-animated', 'progress-bar-striped');
        document.getElementById('ocr-label').textContent = data.aborted
          ? 'Extraction stopped — fill remaining names manually.'
          : 'Name extraction complete ✓';
        if (!data.aborted) setTimeout(function() { banner.classList.add('d-none'); }, 3000);
      }
    })
    .catch(function() { setTimeout(pollOcr, 3000); });
})();

function abortOcr() {
  var btn = document.getElementById('ocr-abort-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'Stopping…'; }
  fetch('/upload-batch/ocr-abort/{{ review_id }}', { method: 'POST' })
    .catch(function() {});
}
{% endif %}

// ── Roster matching ──────────────────────────────────────────────────────────
function matchRoster() {
  const btn = document.getElementById('matchRosterBtn');
  if (!btn) return;
  btn.disabled = true;
  btn.textContent = 'Matching…';

  fetch(`/upload-batch/review/${reviewId}/match-roster`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        alert('Match error: ' + data.error);
        btn.disabled = false;
        btn.textContent = 'Match against Roster';
        return;
      }
      const tierColor = {high: 'success', medium: 'warning', low: 'danger'};
      let high = 0;
      data.results.forEach(m => {
        const nameEl = document.querySelector(`[name="name_${m.exam_index}"]`);
        const sidEl  = document.querySelector(`[name="sid_${m.exam_index}"]`);
        const badge  = document.getElementById(`conf-${m.exam_index}`);
        if (nameEl) nameEl.value = m.name;
        if (sidEl)  sidEl.value  = m.sid;
        if (badge) {
          const pct = Math.round(m.score * 100);
          badge.className = `badge bg-${tierColor[m.tier] || 'secondary'}`;
          badge.textContent = `${pct}%`;
          badge.title = `${m.tier.charAt(0).toUpperCase() + m.tier.slice(1)} confidence`;
        }
        if (m.score >= 0.85) high++;
      });
      const summary = document.getElementById('matchSummary');
      if (summary) {
        summary.textContent = `${high} of ${data.results.length} matched at ≥85% confidence`;
      }
      btn.disabled = false;
      btn.textContent = 'Re-match against Roster';
    })
    .catch(err => {
      alert('Network error: ' + err);
      btn.disabled = false;
      btn.textContent = 'Match against Roster';
    });
}
</script>
{% endblock %}
